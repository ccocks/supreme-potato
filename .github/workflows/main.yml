name: DynamoE Merge

on:
  workflow_dispatch:
    inputs:
      target_repo:
        description: 'Target repository (user/repo)'
        required: true
        default: 'deca-ai/3-ultra-2510'
      models_json:
        description: 'Models JSON (paste entire list)'
        required: true
        default: |
          [
            {"Qwen/Qwen3-VL-235B-A22B-Instruct": true},
            {"Qwen/Qwen3-VL-235B-A22B-Thinking": true},
            {"deepseek-ai/DeepSeek-V3.1-Terminus": true},
            {"moonshotai/Kimi-K2-Instruct-0905": true},
            {"Qwen/Qwen3-Coder-480B-A35B-Instruct": true},
            {"meituan-longcat/LongCat-Flash-Chat": true},
            {"zai-org/GLM-4.5": true},
            {"inclusionAI/Ring-1T-preview": true}
          ]
      worker_count:
        description: 'Number of parallel workers'
        required: true
        default: '4'
        type: choice
        options:
          - '1'
          - '2'
          - '4'
          - '8'

jobs:
  merge:
    runs-on: ubuntu-latest
    strategy:
      max-parallel: ${{ github.event.inputs.worker_count }}
      fail-fast: false
      matrix:
        worker: [1, 2, 3, 4, 5, 6, 7, 8]
    
    steps:
    - name: Check out code
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        cache: 'pip'
    
    - name: Free up disk space
      run: |
        # GitHub Actions has limited disk, free up space
        sudo rm -rf /usr/share/dotnet
        sudo rm -rf /opt/ghc
        sudo rm -rf "/usr/local/share/boost"
        sudo rm -rf "$AGENT_TOOLSDIRECTORY"
        sudo apt-get clean
        df -h
    
    - name: Install dependencies
      run: |
        pip install --no-cache-dir torch --index-url https://download.pytorch.org/whl/cpu
        pip install --no-cache-dir safetensors huggingface_hub
        df -h
    
    - name: Run merger (Worker ${{ matrix.worker }})
      env:
        HF_TOKEN: ${{ secrets.HF_TOKEN }}
        HF_HUB_ENABLE_HF_TRANSFER: 1
        PYTORCH_CUDA_ALLOC_CONF: "max_split_size_mb:512"
      run: |
        # Only run if worker index <= worker_count
        if [ ${{ matrix.worker }} -le ${{ github.event.inputs.worker_count }} ]; then
          echo "Starting worker ${{ matrix.worker }} of ${{ github.event.inputs.worker_count }}"
          
          # Run with small batch size for GitHub Actions
          python dynamoe_merger.py \
            --target "${{ github.event.inputs.target_repo }}" \
            --token "$HF_TOKEN" \
            --models '${{ github.event.inputs.models_json }}' \
            --batch-gb 3.0 \
            --verbose
        else
          echo "Worker ${{ matrix.worker }} not needed (only running ${{ github.event.inputs.worker_count }} workers)"
        fi
      timeout-minutes: 360  # 6 hours max
    
    - name: Cleanup
      if: always()
      run: |
        # Clean up temp files
        rm -rf /tmp/tmp*
        rm -rf ~/.cache/huggingface
        df -h
