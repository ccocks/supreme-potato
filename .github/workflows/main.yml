name: DynamoE Merge

on:
  workflow_dispatch:
    inputs:
      target_repo:
        description: 'Target repository (user/repo)'
        required: true
        default: 'deca-ai/3-ultra-2511'
      models_json:
        description: 'Models JSON (paste entire list)'
        required: true
        default: |
          [
              {"Qwen/Qwen3-VL-235B-A22B-Instruct": true},
              {"Qwen/Qwen3-VL-235B-A22B-Thinking": true},
              {"deepseek-ai/DeepSeek-V3.2-Exp": true},
              {"moonshotai/Kimi-K2-Instruct-0905": true},
              {"Qwen/Qwen3-Coder-480B-A35B-Instruct": true},
              {"meituan-longcat/LongCat-Flash-Chat": true},
              {"zai-org/GLM-4.6": true},
              {"moonshotai/Kimi-K2-Thinking": true},
              {"MiniMaxAI/MiniMax-M2": true}
          ]
      worker_count:
        description: 'Number of parallel workers'
        required: true
        default: '2'
        type: choice
        options:
          - '1'
          - '2'
          - '4'
          - '8'

jobs:
  merge:
    runs-on: ubuntu-latest
    strategy:
      max-parallel: ${{ fromJSON(github.event.inputs.worker_count) }}
      fail-fast: false
      matrix:
        worker: [1, 2, 3, 4]  # Static list - maximum you'll ever need
    
    steps:
    - name: Check out code
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Free up disk space
      run: |
        sudo rm -rf /usr/share/dotnet
        sudo rm -rf /opt/ghc
        sudo rm -rf "/usr/local/share/boost"
        sudo rm -rf "$AGENT_TOOLSDIRECTORY"
        sudo apt-get clean
        df -h
    
    - name: Install dependencies
      run: |
        pip install --no-cache-dir torch --index-url https://download.pytorch.org/whl/cpu
        pip install --no-cache-dir safetensors huggingface_hub numpy torch
        df -h
    
    - name: Skip if worker exceeds count
      id: check_worker
      run: |
        worker_count=${{ github.event.inputs.worker_count }}
        current_worker=${{ matrix.worker }}
        if [ $current_worker -gt $worker_count ]; then
          echo "SKIP=true" >> $GITHUB_ENV
          echo "Worker $current_worker exceeds requested count of $worker_count - skipping"
        else
          echo "SKIP=false" >> $GITHUB_ENV
          echo "Worker $current_worker of $worker_count - proceeding"
        fi
    
    - name: Run merger (Worker ${{ matrix.worker }})
      if: env.SKIP != 'true'
      env:
        HF_TOKEN: ${{ secrets.HF_TOKEN }}
        HF_HUB_ENABLE_HF_TRANSFER: 1
      run: |
        echo "Starting worker ${{ matrix.worker }} of ${{ github.event.inputs.worker_count }}"
        
        python dynamoe_merger.py \
          --target "${{ github.event.inputs.target_repo }}" \
          --token "$HF_TOKEN" \
          --models '${{ github.event.inputs.models_json }}' \
          --disk-fraction 0.7 \
          --verbose
      timeout-minutes: 360
    
    - name: Cleanup
      if: always()
      run: |
        rm -rf /tmp/tmp*
        rm -rf ~/.cache/huggingface
        df -h
